{"version":3,"file":"ImageBuilder.js","sources":["../../../../src/ol/render/canvas/ImageBuilder.js"],"sourcesContent":["/**\r\n * @module ol/render/canvas/ImageBuilder\r\n */\r\nimport CanvasInstruction from './Instruction.js';\r\nimport CanvasBuilder from './Builder.js';\r\n\r\nclass CanvasImageBuilder extends CanvasBuilder {\r\n  /**\r\n   * @param {number} tolerance Tolerance.\r\n   * @param {import(\"../../extent.js\").Extent} maxExtent Maximum extent.\r\n   * @param {number} resolution Resolution.\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @param {boolean} overlaps The builder can have overlapping geometries.\r\n   * @param {?} declutterTree Declutter tree.\r\n   */\r\n  constructor(tolerance, maxExtent, resolution, pixelRatio, overlaps, declutterTree) {\r\n    super(tolerance, maxExtent, resolution, pixelRatio, overlaps, declutterTree);\r\n\r\n    /**\r\n     * @private\r\n     * @type {import(\"../canvas.js\").DeclutterGroup}\r\n     */\r\n    this.declutterGroup_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLCanvasElement|HTMLVideoElement|HTMLImageElement}\r\n     */\r\n    this.hitDetectionImage_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLCanvasElement|HTMLVideoElement|HTMLImageElement}\r\n     */\r\n    this.image_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.anchorX_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.anchorY_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.height_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.opacity_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.originX_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.originY_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean|undefined}\r\n     */\r\n    this.rotateWithView_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.rotation_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.scale_ = undefined;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number|undefined}\r\n     */\r\n    this.width_ = undefined;\r\n\r\n  }\r\n\r\n  /**\r\n   * @param {Array<number>} flatCoordinates Flat coordinates.\r\n   * @param {number} offset Offset.\r\n   * @param {number} end End.\r\n   * @param {number} stride Stride.\r\n   * @private\r\n   * @return {number} My end.\r\n   */\r\n  drawCoordinates_(flatCoordinates, offset, end, stride) {\r\n    return this.appendFlatCoordinates(flatCoordinates, offset, end, stride, false, false);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  drawPoint(pointGeometry, feature) {\r\n    if (!this.image_) {\r\n      return;\r\n    }\r\n    this.beginGeometry(pointGeometry, feature);\r\n    const flatCoordinates = pointGeometry.getFlatCoordinates();\r\n    const stride = pointGeometry.getStride();\r\n    const myBegin = this.coordinates.length;\r\n    const myEnd = this.drawCoordinates_(flatCoordinates, 0, flatCoordinates.length, stride);\r\n    this.instructions.push([\r\n      CanvasInstruction.DRAW_IMAGE, myBegin, myEnd, this.image_,\r\n      // Remaining arguments to DRAW_IMAGE are in alphabetical order\r\n      this.anchorX_, this.anchorY_, this.declutterGroup_, this.height_, this.opacity_,\r\n      this.originX_, this.originY_, this.rotateWithView_, this.rotation_,\r\n      this.scale_ * this.pixelRatio, this.width_\r\n    ]);\r\n    this.hitDetectionInstructions.push([\r\n      CanvasInstruction.DRAW_IMAGE, myBegin, myEnd, this.hitDetectionImage_,\r\n      // Remaining arguments to DRAW_IMAGE are in alphabetical order\r\n      this.anchorX_, this.anchorY_, this.declutterGroup_, this.height_, this.opacity_,\r\n      this.originX_, this.originY_, this.rotateWithView_, this.rotation_,\r\n      this.scale_, this.width_\r\n    ]);\r\n    this.endGeometry(pointGeometry, feature);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  drawMultiPoint(multiPointGeometry, feature) {\r\n    if (!this.image_) {\r\n      return;\r\n    }\r\n    this.beginGeometry(multiPointGeometry, feature);\r\n    const flatCoordinates = multiPointGeometry.getFlatCoordinates();\r\n    const stride = multiPointGeometry.getStride();\r\n    const myBegin = this.coordinates.length;\r\n    const myEnd = this.drawCoordinates_(\r\n      flatCoordinates, 0, flatCoordinates.length, stride);\r\n    this.instructions.push([\r\n      CanvasInstruction.DRAW_IMAGE, myBegin, myEnd, this.image_,\r\n      // Remaining arguments to DRAW_IMAGE are in alphabetical order\r\n      this.anchorX_, this.anchorY_, this.declutterGroup_, this.height_, this.opacity_,\r\n      this.originX_, this.originY_, this.rotateWithView_, this.rotation_,\r\n      this.scale_ * this.pixelRatio, this.width_\r\n    ]);\r\n    this.hitDetectionInstructions.push([\r\n      CanvasInstruction.DRAW_IMAGE, myBegin, myEnd, this.hitDetectionImage_,\r\n      // Remaining arguments to DRAW_IMAGE are in alphabetical order\r\n      this.anchorX_, this.anchorY_, this.declutterGroup_, this.height_, this.opacity_,\r\n      this.originX_, this.originY_, this.rotateWithView_, this.rotation_,\r\n      this.scale_, this.width_\r\n    ]);\r\n    this.endGeometry(multiPointGeometry, feature);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  finish() {\r\n    this.reverseHitDetectionInstructions();\r\n    // FIXME this doesn't really protect us against further calls to draw*Geometry\r\n    this.anchorX_ = undefined;\r\n    this.anchorY_ = undefined;\r\n    this.hitDetectionImage_ = null;\r\n    this.image_ = null;\r\n    this.height_ = undefined;\r\n    this.scale_ = undefined;\r\n    this.opacity_ = undefined;\r\n    this.originX_ = undefined;\r\n    this.originY_ = undefined;\r\n    this.rotateWithView_ = undefined;\r\n    this.rotation_ = undefined;\r\n    this.width_ = undefined;\r\n    return super.finish();\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  setImageStyle(imageStyle, declutterGroup) {\r\n    const anchor = imageStyle.getAnchor();\r\n    const size = imageStyle.getSize();\r\n    const hitDetectionImage = imageStyle.getHitDetectionImage(1);\r\n    const image = imageStyle.getImage(1);\r\n    const origin = imageStyle.getOrigin();\r\n    this.anchorX_ = anchor[0];\r\n    this.anchorY_ = anchor[1];\r\n    this.declutterGroup_ = /** @type {import(\"../canvas.js\").DeclutterGroup} */ (declutterGroup);\r\n    this.hitDetectionImage_ = hitDetectionImage;\r\n    this.image_ = image;\r\n    this.height_ = size[1];\r\n    this.opacity_ = imageStyle.getOpacity();\r\n    this.originX_ = origin[0];\r\n    this.originY_ = origin[1];\r\n    this.rotateWithView_ = imageStyle.getRotateWithView();\r\n    this.rotation_ = imageStyle.getRotation();\r\n    this.scale_ = imageStyle.getScale();\r\n    this.width_ = size[0];\r\n  }\r\n}\r\n\r\n\r\nexport default CanvasImageBuilder;\r\n"],"names":["super","const"],"mappings":"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"}