{"version":3,"file":"Composite.js","sources":["../../../src/ol/renderer/Composite.js"],"sourcesContent":["/**\r\n * @module ol/renderer/canvas/Map\r\n */\r\nimport {CLASS_UNSELECTABLE} from '../css.js';\r\nimport {visibleAtResolution} from '../layer/Layer.js';\r\nimport RenderEvent from '../render/Event.js';\r\nimport RenderEventType from '../render/EventType.js';\r\nimport MapRenderer from './Map.js';\r\nimport SourceState from '../source/State.js';\r\nimport {replaceChildren} from '../dom.js';\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Canvas map renderer.\r\n * @api\r\n */\r\nclass CompositeMapRenderer extends MapRenderer {\r\n\r\n  /**\r\n   * @param {import(\"../PluggableMap.js\").default} map Map.\r\n   */\r\n  constructor(map) {\r\n    super(map);\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLDivElement}\r\n     */\r\n    this.element_ = document.createElement('div');\r\n    const style = this.element_.style;\r\n    style.position = 'absolute';\r\n    style.width = '100%';\r\n    style.height = '100%';\r\n    style.zIndex = '0';\r\n\r\n    this.element_.className = CLASS_UNSELECTABLE + ' ol-layers';\r\n\r\n    const container = map.getViewport();\r\n    container.insertBefore(this.element_, container.firstChild || null);\r\n\r\n    /**\r\n     * @private\r\n     * @type {Array<HTMLElement>}\r\n     */\r\n    this.children_ = [];\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    this.renderedVisible_ = true;\r\n  }\r\n\r\n  /**\r\n   * @param {import(\"../render/EventType.js\").default} type Event type.\r\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\r\n   */\r\n  dispatchRenderEvent(type, frameState) {\r\n    const map = this.getMap();\r\n    if (map.hasListener(type)) {\r\n      const event = new RenderEvent(type, undefined, frameState);\r\n      map.dispatchEvent(event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  renderFrame(frameState) {\r\n    if (!frameState) {\r\n      if (this.renderedVisible_) {\r\n        this.element_.style.display = 'none';\r\n        this.renderedVisible_ = false;\r\n      }\r\n      return;\r\n    }\r\n\r\n    this.calculateMatrices2D(frameState);\r\n    this.dispatchRenderEvent(RenderEventType.PRECOMPOSE, frameState);\r\n\r\n    const layerStatesArray = frameState.layerStatesArray;\r\n    const viewResolution = frameState.viewState.resolution;\r\n\r\n    this.children_.length = 0;\r\n    for (let i = 0, ii = layerStatesArray.length; i < ii; ++i) {\r\n      const layerState = layerStatesArray[i];\r\n      if (!visibleAtResolution(layerState, viewResolution) || layerState.sourceState != SourceState.READY) {\r\n        continue;\r\n      }\r\n\r\n      const layer = layerState.layer;\r\n      const element = layer.render(frameState);\r\n      if (element) {\r\n        const zIndex = layerState.zIndex;\r\n        if (zIndex !== element.style.zIndex) {\r\n          element.style.zIndex = zIndex;\r\n        }\r\n        this.children_.push(element);\r\n      }\r\n    }\r\n\r\n    replaceChildren(this.element_, this.children_);\r\n\r\n    this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE, frameState);\r\n\r\n    if (!this.renderedVisible_) {\r\n      this.element_.style.display = '';\r\n      this.renderedVisible_ = true;\r\n    }\r\n\r\n    this.scheduleRemoveUnusedLayerRenderers(frameState);\r\n    this.scheduleExpireIconCache(frameState);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachLayerAtPixel(pixel, frameState, hitTolerance, callback, layerFilter) {\r\n    const viewState = frameState.viewState;\r\n    const viewResolution = viewState.resolution;\r\n\r\n    const layerStates = frameState.layerStatesArray;\r\n    const numLayers = layerStates.length;\r\n\r\n    for (let i = numLayers - 1; i >= 0; --i) {\r\n      const layerState = layerStates[i];\r\n      const layer = layerState.layer;\r\n      if (visibleAtResolution(layerState, viewResolution) && layerFilter(layer)) {\r\n        const layerRenderer = this.getLayerRenderer(layer);\r\n        if (!layerRenderer) {\r\n          continue;\r\n        }\r\n        const data = layerRenderer.getDataAtPixel(pixel, frameState, hitTolerance);\r\n        if (data) {\r\n          const result = callback(layer, data);\r\n          if (result) {\r\n            return result;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n}\r\n\r\n\r\nexport default CompositeMapRenderer;\r\n"],"names":["super","const","let"],"mappings":"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"}