{"version":3,"file":"VectorImageLayer.js","sources":["../../../../src/ol/renderer/canvas/VectorImageLayer.js"],"sourcesContent":["/**\r\n * @module ol/renderer/canvas/ImageLayer\r\n */\r\nimport ImageCanvas from '../../ImageCanvas.js';\r\nimport ViewHint from '../../ViewHint.js';\r\nimport {equals} from '../../array.js';\r\nimport {getHeight, getWidth, isEmpty} from '../../extent.js';\r\nimport {assign} from '../../obj.js';\r\nimport CanvasImageLayerRenderer from './ImageLayer.js';\r\nimport CanvasVectorLayerRenderer from './VectorLayer.js';\r\n\r\n/**\r\n * @classdesc\r\n * Canvas renderer for image layers.\r\n * @api\r\n */\r\nclass CanvasVectorImageLayerRenderer extends CanvasImageLayerRenderer {\r\n\r\n  /**\r\n   * @param {import(\"../../layer/VectorImage.js\").default} layer Vector image layer.\r\n   */\r\n  constructor(layer) {\r\n    super(layer);\r\n\r\n    /**\r\n     * @type {!Array<string>}\r\n     */\r\n    this.skippedFeatures_ = [];\r\n\r\n    /**\r\n     * @private\r\n     * @type {import(\"./VectorLayer.js\").default}\r\n     */\r\n    this.vectorRenderer_ = new CanvasVectorLayerRenderer(layer);\r\n\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  disposeInternal() {\r\n    this.vectorRenderer_.dispose();\r\n    super.disposeInternal();\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  prepareFrame(frameState, layerState) {\r\n    const pixelRatio = frameState.pixelRatio;\r\n    const viewState = frameState.viewState;\r\n    const viewResolution = viewState.resolution;\r\n\r\n    const hints = frameState.viewHints;\r\n    const vectorRenderer = this.vectorRenderer_;\r\n    const renderedExtent = frameState.extent;\r\n\r\n    if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] && !isEmpty(renderedExtent)) {\r\n      let skippedFeatures = this.skippedFeatures_;\r\n      const context = vectorRenderer.context;\r\n      const imageFrameState = /** @type {import(\"../../PluggableMap.js\").FrameState} */ (assign({}, frameState, {\r\n        size: [\r\n          getWidth(renderedExtent) / viewResolution,\r\n          getHeight(renderedExtent) / viewResolution\r\n        ],\r\n        viewState: /** @type {import(\"../../View.js\").State} */ (assign({}, frameState.viewState, {\r\n          rotation: 0\r\n        }))\r\n      }));\r\n      const newSkippedFeatures = Object.keys(imageFrameState.skippedFeatureUids).sort();\r\n      const image = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function(callback) {\r\n        if (vectorRenderer.prepareFrame(imageFrameState, layerState) &&\r\n              (vectorRenderer.replayGroupChanged ||\r\n              !equals(skippedFeatures, newSkippedFeatures))) {\r\n          context.canvas.width = imageFrameState.size[0] * pixelRatio;\r\n          context.canvas.height = imageFrameState.size[1] * pixelRatio;\r\n          vectorRenderer.renderFrame(imageFrameState, layerState);\r\n          skippedFeatures = newSkippedFeatures;\r\n          callback();\r\n        }\r\n      });\r\n      if (this.loadImage(image)) {\r\n        this.image_ = image;\r\n        this.skippedFeatures_ = skippedFeatures;\r\n      }\r\n    }\r\n\r\n    if (this.image_) {\r\n      const image = this.image_;\r\n      const imageResolution = image.getResolution();\r\n      const imagePixelRatio = image.getPixelRatio();\r\n      this.renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\r\n    }\r\n\r\n    return !!this.image_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback) {\r\n    if (this.vectorRenderer_) {\r\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback);\r\n    } else {\r\n      return super.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback);\r\n    }\r\n  }\r\n}\r\n\r\n\r\nexport default CanvasVectorImageLayerRenderer;\r\n"],"names":["super","image","const","let"],"mappings":"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"}